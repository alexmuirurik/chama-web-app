datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
}

enum Role {
    MEMBER
    ADMIN
    CHAIRMAN
    SECRETARY
    VICE_CHAIRMAN
    TREASURER
}

model User {
    id            String          @id @default(auto()) @map("_id") @db.ObjectId
    name          String?
    email         String?         @unique
    emailVerified DateTime?
    image         String?
    role          Role?           @default(MEMBER)
    chamaId       String?
    accounts      Account[]
    sessions      Session[]
    Authenticator Authenticator[]
    chama         Chama[]
    members       Member[]
    createdAt     DateTime        @default(now())
    updatedAt     DateTime        @updatedAt
}

model Account {
    id                String   @id @default(auto()) @map("_id") @db.ObjectId
    userId            String   @db.ObjectId
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?  @db.String
    access_token      String?  @db.String
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String?  @db.String
    session_state     String?
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt
    user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(auto()) @map("_id") @db.ObjectId
    sessionToken String   @unique
    userId       String   @db.ObjectId
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt
}

model VerificationToken {
    id         String   @id @default(auto()) @map("_id") @db.ObjectId
    identifier String
    token      String
    expires    DateTime

    @@unique([identifier, token])
}

model Authenticator {
    credentialID         String  @id @map("_id")
    userId               String  @db.ObjectId
    providerAccountId    String
    credentialPublicKey  String
    counter              Int
    credentialDeviceType String
    credentialBackedUp   Boolean
    transports           String?
    user                 User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, credentialID])
}

model Images {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    url       String
    chamaId   String?  @db.ObjectId
    memberId  String?  @db.ObjectId
    member    Member?  @relation(fields: [memberId], references: [id], onDelete: Cascade)
    chama     Chama?   @relation(fields: [chamaId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Chama {
    id             String      @id @default(auto()) @map("_id") @db.ObjectId
    name           String
    location       String
    minimumSavings Float?      @default(0)
    nextMeeting    DateTime?
    registrationId String?
    adminId        String      @db.ObjectId
    admin          User        @relation(fields: [adminId], references: [id], onDelete: Cascade)
    Documents      Images[]
    members        Member[]
    loans          ChamaLoan[]
    projects       Projects[]
    createdAt      DateTime    @default(now())
    updatedAt      DateTime    @updatedAt
}

model ChamaLoan {
    id          String    @id @default(auto()) @map("_id") @db.ObjectId
    chamaId     String    @db.ObjectId
    lender      String
    loanAmount  Float     @default(0)
    interest    Float     @default(0)
    termMonths  Int       @default(0)
    dueDate     DateTime
    paymentDate DateTime?
    chama       Chama     @relation(fields: [chamaId], references: [id], onDelete: Cascade)
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
}

model Projects {
    id            String   @id @default(auto()) @map("_id") @db.ObjectId
    chamaId       String   @db.ObjectId
    projectName   String
    estimatedCost Float    @default(0)
    actualCost    Float    @default(0)
    sharesUsed    Float    @default(0)
    chama         Chama    @relation(fields: [chamaId], references: [id], onDelete: Cascade)
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

model Member {
    id             String          @id @default(auto()) @map("_id") @db.ObjectId
    chamaId        String          @db.ObjectId
    userId         String?         @db.ObjectId
    name           String
    email          String
    phoneNumber    String
    role           Role            @default(MEMBER)
    user           User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
    chama          Chama           @relation(fields: [chamaId], references: [id], onDelete: Cascade)
    images         Images[]
    LongTermLoans  LongTermLoan[]
    ShortTermLoans ShortTermLoan[]
    dividends      Dividend[]
    penalties      Penalty[]
    savings        Saving[]
    deductions     Deduction[]
    balanceSheet   BalanceSheet?
    lastSeen       DateTime?
    createdAt      DateTime        @default(now())
    updatedAt      DateTime        @updatedAt
}

model BalanceSheet {
    id                  String     @id @default(auto()) @map("_id") @db.ObjectId
    memberId            String     @unique @db.ObjectId
    nextDeductionId     String?    @db.ObjectId
    previousDeductionId String?    @db.ObjectId
    totalSavings        Float      @default(0)
    totalLongTermLoans  Float      @default(0)
    totalShortTermLoans Float      @default(0)
    totalDividends      Float      @default(0)
    totalPenalties      Float      @default(0)
    totalBalance        Float      @default(0)
    fixedSavings        Float      @default(0)
    member              Member     @relation(fields: [memberId], references: [id], onDelete: Cascade)
    createdAt           DateTime   @default(now())
    updatedAt           DateTime   @updatedAt
    deduction           Deduction? @relation(fields: [deductionId], references: [id])
    deductionId         String?    @db.ObjectId
}

enum TransactionStatus {
    PENDING
    INCOMPLETE
    COMPLETED
}

model Saving {
    id                         String            @id @default(auto()) @map("_id") @db.ObjectId
    amount                     Float
    mPesaRef                   String?
    memberId                   String            @db.ObjectId
    deductionId                String?           @db.ObjectId
    savings                    Float             @default(0)
    nextLongTermLoanRepayment  Float             @default(0)
    nextShortTermLoanRepayment Float             @default(0)
    status                     TransactionStatus @default(PENDING)
    deduction                  Deduction?        @relation(fields: [deductionId], references: [id])
    member                     Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    createdAt                  DateTime          @default(now())
    updatedAt                  DateTime          @updatedAt
}

model Deduction {
    id                     String            @id @default(auto()) @map("_id") @db.ObjectId
    memberId               String            @db.ObjectId
    memberMonth            String
    totalDeposited         Float             @default(0)
    savingsAmount          Float             @default(0)
    longTermLoanRepayment  Float             @default(0)
    shortTermLoanRepayment Float             @default(0)
    penaltiesRepayment     Float             @default(0)
    interest               Float             @default(0)
    longTermLoanId         String?           @db.ObjectId
    shortTermLoanId        String?           @db.ObjectId
    status                 TransactionStatus @default(PENDING)
    longTermLoan           LongTermLoan?     @relation(fields: [longTermLoanId], references: [id], onDelete: Cascade)
    shortTermLoan          ShortTermLoan?    @relation(fields: [shortTermLoanId], references: [id], onDelete: Cascade)
    member                 Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    savings                Saving[]
    penalties              Penalty[]
    createdAt              DateTime          @default(now())
    updatedAt              DateTime          @updatedAt
    balanceSheets          BalanceSheet[]
}

model LongTermLoan {
    id          String            @id @default(auto()) @map("_id") @db.ObjectId
    memberId    String            @db.ObjectId
    principle   Float             @default(0)
    loanAmount  Float             @default(0)
    interest    Float             @default(0)
    termMonths  Int               @default(0)
    dueDate     DateTime          @default(now())
    paymentDate DateTime          @default(now())
    status      TransactionStatus @default(PENDING)
    member      Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    deductions  Deduction[]
    penalties   Penalty[]
    createdAt   DateTime          @default(now())
    updatedAt   DateTime          @updatedAt
}

model ShortTermLoan {
    id          String            @id @default(auto()) @map("_id") @db.ObjectId
    memberId    String            @db.ObjectId
    principle   Float             @default(0)
    loanAmount  Float             @default(0)
    interest    Float             @default(0)
    termMonths  Int               @default(0)
    dueDate     DateTime          @default(now())
    paymentDate DateTime          @default(now())
    status      TransactionStatus @default(PENDING)
    member      Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    deductions  Deduction[]
    penalties   Penalty[]
    createdAt   DateTime          @default(now())
    updatedAt   DateTime          @updatedAt
}

model Penalty {
    id              String            @id @default(auto()) @map("_id") @db.ObjectId
    memberId        String            @db.ObjectId
    longTermLoanId  String?           @db.ObjectId
    shortTermLoanId String?           @db.ObjectId
    penaltyAmount   Float             @default(0)
    deductionId     String?           @db.ObjectId
    status          TransactionStatus @default(PENDING)
    longTermLoan    LongTermLoan?     @relation(fields: [longTermLoanId], references: [id], onDelete: Cascade)
    shortTermLoan   ShortTermLoan?    @relation(fields: [shortTermLoanId], references: [id], onDelete: Cascade)
    deduction       Deduction?        @relation(fields: [deductionId], references: [id], onDelete: Cascade)
    member          Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @updatedAt
}

model Dividend {
    id             String            @id @default(auto()) @map("_id") @db.ObjectId
    memberId       String            @db.ObjectId
    dividendAmount Float             @default(0)
    dueDate        DateTime?
    paidAt         DateTime?
    status         TransactionStatus @default(PENDING)
    member         Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    createdAt      DateTime          @default(now())
    updatedAt      DateTime          @updatedAt
}
