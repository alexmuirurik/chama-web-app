datasource db {
    provider = "postgresql"
}

generator client {
    provider = "prisma-client"
    output   = "../src/generate/prisma"
}

enum Role {
    MEMBER
    ADMIN
    CHAIRMAN
    SECRETARY
    VICE_CHAIRMAN
    TREASURER
}

model User {
    id            String          @id @default(uuid()) @map("_id")
    name          String?
    email         String?         @unique
    emailVerified DateTime?
    image         String?
    role          Role?           @default(MEMBER)
    chamaId       String?
    accounts      Account[]
    sessions      Session[]
    Authenticator Authenticator[]
    chama         Chama[]
    members       Member[]
    createdAt     DateTime        @default(now())
    updatedAt     DateTime        @updatedAt
}

model Account {
    id                String   @id @default(uuid()) @map("_id")
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?
    access_token      String?
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String?
    session_state     String?
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt
    user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(uuid()) @map("_id")
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt
}

model VerificationToken {
    id         String   @id @default(uuid()) @map("_id")
    identifier String
    token      String
    expires    DateTime

    @@unique([identifier, token])
}

model Authenticator {
    credentialID         String  @id @map("_id")
    userId               String
    providerAccountId    String
    credentialPublicKey  String
    counter              Int
    credentialDeviceType String
    credentialBackedUp   Boolean
    transports           String?
    user                 User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, credentialID])
}

model Chama {
    id                   String      @id @default(uuid()) @map("_id")
    name                 String
    location             String
    registrationDocument String?
    minimumSavings       Float       @default(0)
    interestRate         Float       @default(10)
    nextMeeting          DateTime?
    registrationId       String?
    adminId              String
    admin                User        @relation(fields: [adminId], references: [id], onDelete: Cascade)
    members              Member[]
    loans                ChamaLoan[]
    projects             Projects[]
    createdAt            DateTime    @default(now())
    updatedAt            DateTime    @updatedAt
}

model ChamaLoan {
    id          String    @id @default(uuid()) @map("_id")
    chamaId     String
    lender      String
    loanAmount  Float     @default(0)
    interest    Float     @default(0)
    termMonths  Int       @default(0)
    dueDate     DateTime
    paymentDate DateTime?
    chama       Chama     @relation(fields: [chamaId], references: [id], onDelete: Cascade)
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
}

model Projects {
    id            String   @id @default(uuid()) @map("_id")
    chamaId       String
    projectName   String
    estimatedCost Float    @default(0)
    actualCost    Float    @default(0)
    sharesUsed    Float    @default(0)
    chama         Chama    @relation(fields: [chamaId], references: [id], onDelete: Cascade)
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

model Member {
    id           String        @id @default(uuid()) @map("_id")
    chamaId      String
    userId       String?
    name         String
    email        String
    phoneNumber  String
    role         Role          @default(MEMBER)
    user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
    chama        Chama         @relation(fields: [chamaId], references: [id], onDelete: Cascade)
    dividends    Dividend[]
    penalties    Penalty[]
    savings      Saving[]
    loans        Loan[]
    shortLoans   ShortLoan[]
    balanceSheet BalanceSheet?
    lastSeen     DateTime?
    createdAt    DateTime      @default(now())
    updatedAt    DateTime      @updatedAt
}

model BalanceSheet {
    id                 String   @id @default(uuid()) @map("_id")
    memberId           String   @unique
    loanLimit          Float    @default(0)
    shortLoanLimit     Float    @default(0)
    totalSavings       Float    @default(0)
    totalLongTermLoan  Float    @default(0)
    totalShortTermLoan Float    @default(0)
    totalDividend      Float    @default(0)
    totalPenalties     Float    @default(0)
    totalUnpaid        Float    @default(0)
    fixedSavings       Float    @default(0)
    welfare            Float    @default(0)
    member             Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
    createdAt          DateTime @default(now())
    updatedAt          DateTime @updatedAt
}

enum TransactionStatus {
    PENDING
    INCOMPLETE
    COMPLETED
}

model Saving {
    id           String            @id @default(uuid()) @map("_id")
    amount       Float
    mPesaRef     String?
    authorizedBy String?
    loanId       String?
    shortLoanId  String?
    penaltyId    String?
    memberId     String
    status       TransactionStatus @default(PENDING)
    member       Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    loan         Loan?             @relation(fields: [loanId], references: [id], onDelete: Cascade)
    shortLoan    ShortLoan?        @relation(fields: [shortLoanId], references: [id], onDelete: Cascade)
    penalty      Penalty?          @relation(fields: [penaltyId], references: [id], onDelete: Cascade)
    deduction    Deduction?
    createdAt    DateTime          @default(now())
    updatedAt    DateTime          @updatedAt
}

model Deduction {
    id              String            @id @default(uuid()) @map("_id")
    savingId        String            @unique
    amount          Float             @default(0)
    loanAmount      Float             @default(0)
    shortLoanAmount Float             @default(0)
    penaltyAmount   Float             @default(0)
    savings         Float             @default(0)
    welfare         Float             @default(0)
    status          TransactionStatus @default(PENDING)
    saving          Saving            @relation(fields: [savingId], references: [id], onDelete: Cascade)
    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @updatedAt
}

enum LoanType {
    LONG_TERM
    SHORT_TERM
}

model Loan {
    id               String            @id @default(uuid()) @map("_id")
    memberId         String
    principle        Float             @default(0)
    loanAmount       Float             @default(0)
    interest         Float             @default(0)
    termMonths       Int               @default(0)
    monthlyRepayment Float             @default(0)
    paymentDate      DateTime?
    loanDocument     String?
    loanType         LoanType          @default(LONG_TERM)
    guarantors       String[]
    status           TransactionStatus @default(PENDING)
    member           Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    penalties        Penalty[]
    savings          Saving[]
    createdAt        DateTime          @default(now())
    updatedAt        DateTime          @updatedAt
}

model ShortLoan {
    id           String            @id @default(uuid()) @map("_id")
    memberId     String
    principle    Float             @default(0)
    loanAmount   Float             @default(0)
    interest     Float             @default(0)
    paymentDate  DateTime?
    loanDocument String?
    loanType     LoanType          @default(SHORT_TERM)
    guarantors   String[]
    status       TransactionStatus @default(PENDING)
    member       Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    penalties    Penalty[]
    savings      Saving[]
    createdAt    DateTime          @default(now())
    updatedAt    DateTime          @updatedAt
}

model Penalty {
    id            String            @id @default(uuid()) @map("_id")
    memberId      String
    loanId        String?
    shortLoanId   String?
    penaltyAmount Float             @default(0)
    status        TransactionStatus @default(PENDING)
    member        Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    loan          Loan?             @relation(fields: [loanId], references: [id], onDelete: Cascade)
    shortLoan     ShortLoan?        @relation(fields: [shortLoanId], references: [id], onDelete: Cascade)
    savings       Saving[]
    createdAt     DateTime          @default(now())
    updatedAt     DateTime          @updatedAt
}

model Dividend {
    id             String            @id @default(uuid()) @map("_id")
    memberId       String
    dividendAmount Float             @default(0)
    dueDate        DateTime?
    paidAt         DateTime?
    status         TransactionStatus @default(PENDING)
    member         Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
    createdAt      DateTime          @default(now())
    updatedAt      DateTime          @updatedAt
}
